# IfcTester ArchiCAD Add-On

IDS authoring and auditing tool for ArchiCAD. This add-on embeds the IfcTester web application within ArchiCAD, providing IFC model validation and IDS (Information Delivery Specification) tools.

## Features

- **Embedded Web Interface**: Uses ArchiCAD's Browser Control (CEF) to host the IfcTester web application
- **ArchiCAD Integration**: 
  - Select elements in ArchiCAD from IFC validation results
  - View selected elements' IFC properties
  - Export IFC directly from the panel
- **REST API Server**: Built-in HTTP server for communication between web interface and ArchiCAD API

## Requirements

### For Building

- **Visual Studio 2022** with C++ desktop development workload
- **ArchiCAD API Development Kit** (version 25, 26, or 27)
- **Windows 10/11** (64-bit)

### For Running

- **ArchiCAD 25, 26, or 27** (Windows)

## Quick Start Guide

### Full Build & Install Command

Run this single command to build and install everything:

```powershell
.\scripts\build-and-install.ps1 -Configuration Debug -ArchiCADVersion 27
```

### Command Options

- `-Configuration`: `Debug` or `Release` (default: `Release`)
- `-ArchiCADVersion`: `25`, `26`, `27`, or `29` (default: `27`)
- `-SkipBuild`: Skip building (only copy existing build)
- `-SkipCopy`: Skip copying (only build)
- `-SkipVerify`: Skip verification step

### Examples

**Debug build for ArchiCAD 27:**
```powershell
.\scripts\build-and-install.ps1 -Configuration Debug -ArchiCADVersion 27
```

**Release build for ArchiCAD 27:**
```powershell
.\scripts\build-and-install.ps1 -Configuration Release -ArchiCADVersion 27
```

**Only copy existing build (skip build step):**
```powershell
.\scripts\build-and-install.ps1 -SkipBuild
```

**Only build (don't copy):**
```powershell
.\scripts\build-and-install.ps1 -SkipCopy
```

### What the Script Does

1. **Builds the web app** (if `dist` folder is missing or outdated)
2. **Configures CMake** (if `cmake-build` doesn't exist - generates Visual Studio project files)
3. **Builds the ArchiCAD add-on** using MSBuild
4. **Copies the `.apx` file** to ArchiCAD Add-Ons folder
5. **Copies the `WebApp` folder** to ArchiCAD Add-Ons folder
6. **Verifies** the installation (compares build vs installed)

**Note:** The `cmake-build/` directory is gitignored because it contains generated files. The build script automatically runs CMake configure if needed. All source files (`CMakeLists.txt`, source code, resources) are tracked in git.

### After Installation

1. **Restart ArchiCAD** (if it was running)
2. **Open the Report window**: `Window → Palettes → Report`
3. **Look for these messages**:
   - ✅ `IfcTester ArchiCAD Add-On v1.0.0 (Built: [date] [time])`
   - ✅ `IfcTester: API server started on http://127.0.0.1:48882`

### Quick Start Troubleshooting

#### If the API server doesn't start:

1. **Check the Report window** for error messages
2. **Check port availability**:
   ```powershell
   netstat -ano | findstr :48882
   ```
3. **Verify installation**:
   ```powershell
   .\scripts\verify-build.ps1 -Configuration Debug -ArchiCADVersion 27
   ```

#### If build fails:

1. **Check CMake is installed**: `cmake --version` (required for initial CMake configuration)
2. **Check Visual Studio 2022** is installed with C++ tools
3. **Check DevKit path**: Set `ARCHICAD_API_DEVKIT` environment variable, or the script will try to find it automatically
4. **Check web app is built**: `cd web && npm run build`

### Understanding the Build Process

The `cmake-build/` directory is **gitignored** because it contains generated files. Here's how it works:

1. **First build**: The build script detects that `cmake-build/` doesn't exist and automatically runs `cmake configure` to generate it
2. **Subsequent builds**: The script uses the existing `cmake-build/` directory
3. **Clean rebuild**: Delete `cmake-build/` folder and run the build script again - CMake will regenerate everything

**Using Visual Studio directly:**

After running the build script once (or manually running `cmake configure`), you can open the generated solution file directly in Visual Studio:

```
archicad\cmake-build\IfcTesterArchiCAD.sln
```

This `.sln` file is **generated by CMake** - it's not tracked in git, but CMake recreates it automatically. This is the standard CMake workflow.

**All source files are tracked in git:**
- ✅ `CMakeLists.txt` - CMake configuration (source)
- ✅ `CMakeSettings.json` - Visual Studio CMake settings (source)
- ✅ `Src/` - All C++ source files
- ✅ `RFIX/`, `RINT/` - Resource files
- ❌ `cmake-build/` - Generated files (gitignored, recreated by CMake)
  - Includes: `.sln`, `.vcxproj`, `CMakeCache.txt`, build outputs, etc.

### Individual Scripts

If you need more control, use these individual scripts:

- **Build only**: `.\scripts\build-archicad.ps1`
- **Copy only**: `.\scripts\copy-build.ps1`
- **Verify only**: `.\scripts\verify-build.ps1`

### File Locations

- **Build output**: `archicad\cmake-build\Debug\IfcTesterArchiCAD.apx` (or `Release`)
- **Installed location**: `%APPDATA%\Graphisoft\ArchiCAD 27\Add-Ons\IfcTesterArchiCAD\`
- **Web app dist**: `web\dist\`
- **Web app installed**: `%APPDATA%\Graphisoft\ArchiCAD 27\Add-Ons\IfcTesterArchiCAD\WebApp\`

## Building

### Prerequisites

1. Install Visual Studio 2022 with:
   - Desktop development with C++
   - Windows 10/11 SDK

2. Download the ArchiCAD API Development Kit from:
   https://archicadapi.graphisoft.com/

3. Set the `ARCHICAD_API_DEVKIT` environment variable to your DevKit path:
   ```powershell
   $env:ARCHICAD_API_DEVKIT = "C:\Program Files\GRAPHISOFT\API Development Kit 27"
   ```

### Build Steps

#### Using PowerShell Script (Recommended)

```powershell
# From project root - this handles CMake configuration automatically
.\scripts\build-and-install.ps1 -Configuration Release -ArchiCADVersion 27
```

Or build only:
```powershell
.\scripts\build-archicad.ps1 -Configuration Release -ArchiCADVersion 27
```

#### Using CMake + Visual Studio

1. **Configure CMake** (generates `cmake-build/` directory and `.sln` file):
   ```powershell
   cd archicad
   cmake -B cmake-build -S . -G "Visual Studio 17 2022" -A x64 -DAC_API_DEVKIT_DIR="C:\Program Files\GRAPHISOFT\API Development Kit 27"
   ```

2. **Open in Visual Studio**:
   - Open `cmake-build\IfcTesterArchiCAD.sln` in Visual Studio 2022
   - Build from Visual Studio (F7 or Build → Build Solution)
   - The `.sln` file is generated by CMake - it's gitignored but CMake recreates it automatically

   **OR build from command line:**
   ```powershell
   cmake --build cmake-build --config Release
   ```

**Note:** The `cmake-build/` directory (including `IfcTesterArchiCAD.sln`) is gitignored because it contains generated files. CMake will recreate everything when you run `cmake configure`. The source files (`CMakeLists.txt`, `CMakeSettings.json`, and all source code) are tracked in git.

### Build Output

The compiled add-on will be located at:
```
archicad\cmake-build\Release\IfcTesterArchiCAD.apx
```

## Installation

### Manual Installation

1. Build the add-on (see above)
2. Copy `IfcTesterArchiCAD.apx` to your ArchiCAD Add-Ons folder:
   - Windows: `%APPDATA%\Graphisoft\ArchiCAD 27\Add-Ons\IfcTesterArchiCAD\`
3. Copy the `web\dist` folder to `%APPDATA%\Graphisoft\ArchiCAD 27\Add-Ons\IfcTesterArchiCAD\WebApp`
4. Restart ArchiCAD

### Using Installer

1. Run `IfcTesterArchiCAD-Setup-vX.X.X.exe`
2. Follow the installation wizard
3. The installer will automatically detect installed ArchiCAD versions

## Usage

1. Open ArchiCAD
2. Go to **Audit** > **IFC Testing** > **IfcTester Panel**
3. The IfcTester panel will open as a dockable palette
4. Use the web interface to:
   - Load IDS files
   - Validate IFC models
   - Select elements in ArchiCAD from validation results

## Checking Add-On Status

### Method 1: Check if API Server is Running

#### Using PowerShell:
```powershell
# Check if port 48882 is listening
netstat -ano | findstr :48882

# Test connection
Test-NetConnection -ComputerName localhost -Port 48882
```

**Expected output if server is running:**
```
TCP    127.0.0.1:48882        0.0.0.0:0              LISTENING        [PID]
```

#### Using Browser:
Open your browser and navigate to:
```
http://localhost:48882/status
```

**Expected response if server is running:**
```json
{"status":"ok","connected":true,"configsReady":true,"version":"1.0.0"}
```

#### Using curl:
```powershell
curl http://localhost:48882/status
```

### Method 2: Check if Add-On Menu Appears

1. **Open ArchiCAD**
2. **Look for the menu**: `Audit` → `IFC Testing` → `IfcTester Panel`
   - If you see this menu, the add-on is loaded
   - If you don't see it, the add-on may not be loading

### Method 3: Find the Report Window in ArchiCAD 27

The Report window location varies by ArchiCAD version:

#### Option A: Window Menu
1. Go to **Window** menu
2. Look for **Palettes** submenu
3. Select **Report** (or **Report Window**)

#### Option B: View Menu
1. Go to **View** menu
2. Look for **Palettes** or **Windows**
3. Select **Report**

#### Option C: Action Center
1. Go to **File** → **Info** → **Action Center**
2. Look for **Reports** or **Session Reports** section
3. This may contain add-on messages

#### Option D: Add-On Manager
1. Go to **Options** → **Add-On Manager** (or **File** → **Add-On Manager**)
2. Look for **IfcTester ArchiCAD** in the list
3. Check if it's enabled and if there are any error messages

### Method 4: Check Add-On Files

Verify the add-on files are in the correct location:

```powershell
# Check if add-on file exists
Test-Path "$env:APPDATA\Graphisoft\ArchiCAD 27\Add-Ons\IfcTesterArchiCAD\IfcTesterArchiCAD.apx"

# Check file details
Get-Item "$env:APPDATA\Graphisoft\ArchiCAD 27\Add-Ons\IfcTesterArchiCAD\IfcTesterArchiCAD.apx" | Select-Object Name, Length, LastWriteTime
```

### Method 5: Try Opening the Panel

1. In ArchiCAD, try to open the IfcTester panel:
   - Go to **Audit** → **IFC Testing** → **IfcTester Panel**
   - Or use the menu item if it appears
2. If the panel opens, the add-on is loaded
3. If you get an error, check what the error message says

### Method 6: Check Windows Event Viewer

1. Open **Event Viewer** (Windows key + R, type `eventvwr`)
2. Navigate to **Windows Logs** → **Application**
3. Look for entries related to ArchiCAD or IfcTester
4. Check for any error messages

### Quick Status Check Script

Run this PowerShell command to check everything at once:

```powershell
Write-Host "=== IfcTester Add-On Status Check ===" -ForegroundColor Cyan
Write-Host ""

# Check if port is listening
Write-Host "1. Checking API server port..." -ForegroundColor Yellow
$portCheck = netstat -ano | findstr :48882
if ($portCheck) {
    Write-Host "   ✓ Port 48882 is LISTENING" -ForegroundColor Green
    Write-Host "   $portCheck" -ForegroundColor Gray
} else {
    Write-Host "   ✗ Port 48882 is NOT listening" -ForegroundColor Red
    Write-Host "   The API server is not running" -ForegroundColor Yellow
}

Write-Host ""

# Check if add-on file exists
Write-Host "2. Checking add-on installation..." -ForegroundColor Yellow
$addonPath = "$env:APPDATA\Graphisoft\ArchiCAD 27\Add-Ons\IfcTesterArchiCAD\IfcTesterArchiCAD.apx"
if (Test-Path $addonPath) {
    $file = Get-Item $addonPath
    Write-Host "   ✓ Add-on file found" -ForegroundColor Green
    Write-Host "   Location: $addonPath" -ForegroundColor Gray
    Write-Host "   Size: $([math]::Round($file.Length / 1KB, 2)) KB" -ForegroundColor Gray
    Write-Host "   Modified: $($file.LastWriteTime)" -ForegroundColor Gray
} else {
    Write-Host "   ✗ Add-on file NOT found" -ForegroundColor Red
    Write-Host "   Expected: $addonPath" -ForegroundColor Gray
}

Write-Host ""

# Test API server connection
Write-Host "3. Testing API server connection..." -ForegroundColor Yellow
try {
    $response = Invoke-WebRequest -Uri "http://localhost:48882/status" -TimeoutSec 2 -ErrorAction Stop
    Write-Host "   ✓ API server is responding" -ForegroundColor Green
    Write-Host "   Response: $($response.Content)" -ForegroundColor Gray
} catch {
    Write-Host "   ✗ API server is NOT responding" -ForegroundColor Red
    Write-Host "   Error: $($_.Exception.Message)" -ForegroundColor Gray
}

Write-Host ""
Write-Host "=== Status Check Complete ===" -ForegroundColor Cyan
```

### Status Check Troubleshooting

#### If port is NOT listening:
- The add-on may not be loading
- Check ArchiCAD Add-On Manager for errors
- Restart ArchiCAD completely
- Check if the add-on file is in the correct location

#### If port IS listening but web app can't connect:
- Check CORS headers (use browser dev tools)
- Check firewall settings
- Try accessing `http://localhost:48882/status` directly in a browser

#### If add-on menu doesn't appear:
- The add-on may have failed to load
- Check Add-On Manager for error messages
- Verify the `.apx` file is not corrupted
- Try rebuilding and reinstalling

## Architecture

```
archicad/
├── Src/
│   ├── Main.cpp                 # Add-On entry point (4 required functions)
│   ├── IfcTesterArchiCAD.hpp    # Main header with types and declarations
│   ├── BrowserPalette.cpp/hpp   # Browser control palette implementation
│   └── ArchiCADApiServer.cpp/hpp # HTTP REST API server
├── RFIX/                        # Non-localizable resources
│   └── IfcTesterArchiCADFix.grc # MDID resource
├── RINT/                        # Localizable resources
│   └── IfcTesterArchiCAD.grc    # Strings, menus, dialogs
├── RFIX.win/                    # Windows-specific resources
│   └── IfcTesterArchiCAD.rc2    # Windows resource file
└── Resources/Icons/             # Add-on icons
```

### Key Components

#### BrowserPalette
A dockable modeless dialog (palette) that hosts the embedded browser control. Uses ArchiCAD's DG::Browser class which wraps CEF (Chromium Embedded Framework).

#### JavaScript Bridge
The add-on registers an `ACAPI` JavaScript object in the browser that provides:
- `ACAPI.GetSelectedElements()` - Get information about selected elements
- `ACAPI.SelectElementByGUID(guid)` - Select an element by its IFC GUID
- `ACAPI.AddElementToSelection(guid)` - Add an element to the selection
- `ACAPI.RemoveElementFromSelection(guid)` - Remove an element from selection
- `ACAPI.GetIFCConfigurations()` - Get available IFC export configurations
- `ACAPI.ExportToIFC(configName)` - Export model to IFC

#### REST API Server
HTTP server (port 48882) providing REST endpoints:
- `GET /status` - Server status and connection check
- `GET /select-by-guid/{guid}` - Select element by IFC GUID
- `GET /ifc-configurations` - List available IFC export configurations
- `POST /export-ifc` - Export model to IFC format

## API Port Configuration

The ArchiCAD add-on uses port **48882** by default (different from Revit's port 48881 to allow both plugins to run simultaneously).

## Debugging

### Verifying Build Installation

#### Check if Correct Version is Installed

1. **Use the verification script:**
   ```powershell
   .\scripts\verify-build.ps1 -Configuration Release -ArchiCADVersion 27
   ```
   This will compare the build output with the installed version and report any mismatches.

2. **Manual verification:**
   - Build output: `archicad\cmake-build\Release\IfcTesterArchiCAD.apx`
   - Installed location: `%APPDATA%\Graphisoft\ArchiCAD 27\Add-Ons\IfcTesterArchiCAD\IfcTesterArchiCAD.apx`
   - Compare file modification times and sizes

3. **Copy the build (if outdated):**
   ```powershell
   .\scripts\copy-build.ps1 -Configuration Release -ArchiCADVersion 27
   ```
   This script will:
   - Check if ArchiCAD is running (and warn if so)
   - Copy the `.apx` file to the Add-Ons folder
   - Copy the `WebApp` folder
   - Provide next steps

#### Check ArchiCAD Report Window

**IMPORTANT:** `ACAPI_WriteReport` messages appear in ArchiCAD's Report window, NOT in Visual Studio output!

1. **Open the Session Report window:**
   - In ArchiCAD: `Window → Palettes → Report`
   - This is where `ACAPI_WriteReport` messages appear
   - Alternative locations (varies by version):
     - `File → Info → Session Report`
     - `View → Palettes → Report`

2. **Look for add-on initialization messages:**
   - `IfcTester ArchiCAD Add-On v1.0.0 (Built: [date] [time])`
   - `IfcTester: API server started on http://127.0.0.1:48882` (success)
   - `IfcTester: Failed to start API server on port 48882` (failure)

3. **If you don't see any messages:**
   - The add-on may not be loading
   - Check if the `.apx` file is in the correct location
   - Check if ArchiCAD shows any add-on errors on startup
   - Verify the add-on is enabled in ArchiCAD's Add-On Manager

### API Server Connection Issues

#### Symptoms
- Web app cannot connect to ArchiCAD API server
- Connection timeout errors
- CORS errors in browser console
- `ERR_SOCKET_NOT_CONNECTED` error

#### Debugging Steps

1. **Verify API Server is Starting**
   - **Check ArchiCAD's Report window** (Window → Palettes → Report)
   - Look for messages like:
     - `IfcTester: API server started on http://127.0.0.1:48882` (success)
     - `IfcTester: Failed to start API server on port 48882` (failure)
   - If failure, check if port 48882 is already in use
   - **Note:** These messages appear in the Report window, NOT Visual Studio output!

2. **Test API Server Manually**
   - Open PowerShell or Command Prompt
   - Run: `curl http://localhost:48882/status`
   - Or use browser: Navigate to `http://localhost:48882/status`
   - Expected response: `{"status":"ok","connected":true,"configsReady":true,"version":"1.0.0"}`

3. **Check Port Availability**
   ```powershell
   netstat -ano | findstr :48882
   ```
   - If port is in use, either:
     - Close the application using it
     - Change `ApiServerPort` in `IfcTesterArchiCAD.hpp`

4. **CEF Browser Debugging**
   - Enable CEF debug port (see below)
   - Open Chrome and navigate to `http://localhost:9222`
   - Select the IfcTester page
   - Check Console tab for JavaScript errors
   - Check Network tab for failed requests

5. **Common Issues**

   **Issue: Port Already in Use**
   - **Symptom**: `Failed to bind to port 48882 (error 10048)`
   - **Solution**: Close other applications using port 48882, or change the port

   **Issue: CORS Errors**
   - **Symptom**: `Access to fetch at 'http://localhost:48882/status' from origin 'http://localhost:5173' has been blocked by CORS policy`
   - **Solution**: Verify CORS headers are being sent (check Network tab in CEF debugger)

   **Issue: Connection Timeout / ERR_SOCKET_NOT_CONNECTED**
   - **Symptom**: `ERR_SOCKET_NOT_CONNECTED` or `Failed to fetch` in browser console
   - **Solution**: 
     1. **First, check the ArchiCAD Report window** (Window → Palettes → Report)
        - Look for `IfcTester:` messages
        - If you see "Failed to start API server", check the error code
     2. Verify add-on is loaded (check Add-On Manager in ArchiCAD)
     3. Check if port 48882 is listening:
        ```powershell
        netstat -ano | findstr :48882
        ```
        - If you see `LISTENING`, the server is running
        - If you see `TIME_WAIT`, connections were made but closed
        - If nothing, the server isn't running
     4. Rebuild and reinstall the add-on:
        ```powershell
        cd archicad\cmake-build
        cmake --build . --config Release
        cd ..\..
        .\scripts\copy-build.ps1 -Configuration Release -ArchiCADVersion 27
        ```
     5. Restart ArchiCAD completely (close all instances)
     6. Check if Winsock initialization failed (look for "WSAStartup failed" in Report window)
     - Check ArchiCAD report window for errors
     - Verify API server started successfully

   **Issue: Network Error**
   - **Symptom**: `Failed to fetch` or `NetworkError`
   - **Solution**:
     - Check Windows Firewall settings
     - Verify `127.0.0.1:48882` is accessible
     - Check if CEF has network restrictions

### CEF Browser Debugging

#### Enable CEF Debug Port

1. Open Registry Editor (`regedit`)
2. Navigate to: `HKEY_CURRENT_USER\SOFTWARE\GRAPHISOFT\Debug\DG`
3. Create DWORD value: `CefDebugPort` = `9222`
   - Or create: `CefUseFixedDebugPort` = `1`
4. Restart ArchiCAD
5. Open Chrome and navigate to: `http://localhost:9222`
6. Click on your panel's page to debug

#### CEF Limitations

- **Chromium Version**: ArchiCAD's CEF may use an older Chromium version
- **CSS Support**: Some modern CSS features may not be fully supported
- **JavaScript**: Most ES6+ features should work, but some newer APIs may not
- **Web Workers**: Work with HTTP servers, but NOT with `file://` URLs

### CSS Rendering Differences

#### Potential Causes

1. **CEF Chromium Version**: Older Chromium may not support all CSS features
2. **Missing CSS Variables**: CEF might not fully support CSS custom properties
3. **Font Rendering**: Different font rendering between CEF and modern browsers
4. **Viewport Units**: CEF might handle `vh`/`vw` differently

#### Solutions

1. **Check CEF Version**: Use JavaScript to detect:
   ```javascript
   console.log('User Agent:', navigator.userAgent);
   console.log('Chrome Version:', navigator.userAgent.match(/Chrome\/(\d+)/)?.[1]);
   ```

2. **Use CSS Fallbacks**: Provide fallbacks for newer CSS features
3. **Test in CEF**: Always test UI in the actual CEF browser, not just Chrome

### JavaScript Debugging in CEF

1. Set the Windows registry key:
   ```
   HKEY_CURRENT_USER\SOFTWARE\GRAPHISOFT\Debug\DG
   CefDebugPort = 9222 (DWORD)
   ```
   Or set `CefUseFixedDebugPort = 1` (DWORD)

2. Start ArchiCAD and open the IfcTester panel
3. Open Chrome and navigate to `http://localhost:9222`
4. Select the IfcTester page to debug

### Visual Studio Debugging

#### Setup

1. Build with Debug configuration
2. Copy `.apx` file to ArchiCAD Add-Ons folder
3. In Visual Studio: Debug → Attach to Process
4. Select `ARCHICAD.exe`
5. Set breakpoints in C++ code

#### Common Breakpoints

- `ArchiCADApiServer::Start()` - Verify server starts
- `ArchiCADApiServer::ServerLoop()` - Check if requests are received
- `ArchiCADApiServer::HandleRequest()` - Debug request handling
- `BrowserPalette::InitBrowserControl()` - Check URL construction

### Network Testing

#### Test API Server from Command Line

```powershell
# Test status endpoint
Invoke-WebRequest -Uri "http://localhost:48882/status" -Method GET

# Test with curl (if available)
curl http://localhost:48882/status

# Check if port is listening
Test-NetConnection -ComputerName localhost -Port 48882
```

#### Expected Responses

**Status Endpoint** (`GET /status`):
```json
{
  "status": "ok",
  "connected": true,
  "configsReady": true,
  "version": "1.0.0"
}
```

**IFC Configurations** (`GET /ifc-configurations`):
```json
{
  "configurations": [
    {
      "name": "IFC2x3",
      "description": "IFC2x3 Export",
      "version": "2x3"
    }
  ]
}
```

### Debugging Checklist

- [ ] Add-on is loaded in ArchiCAD (check Add-On Manager)
- [ ] API server started successfully (check Report window)
- [ ] Port 48882 is not in use by another application
- [ ] Web dev server is running on port 5173
- [ ] CEF debug port is enabled (9222)
- [ ] Browser can access `http://localhost:48882/status` directly
- [ ] CORS headers are present in API responses
- [ ] No firewall blocking localhost connections
- [ ] JavaScript console shows connection attempts
- [ ] Network tab shows failed requests (if any)

### Getting Help

If issues persist:

1. Check ArchiCAD Report window for errors
2. Enable CEF debugging and check browser console
3. Test API server manually with curl/browser
4. Check Visual Studio debugger for C++ errors
5. Verify all dependencies are correct (DevKit version, etc.)

## Development Guide

This section summarizes key learnings, common issues, and solutions for building ArchiCAD C++ Add-Ons.

### Table of Contents

1. [Development Environment Setup](#development-environment-setup)
2. [DevKit Versions and Compatibility](#devkit-versions-and-compatibility)
3. [MDID (Module Identifier)](#mdid-module-identifier)
4. [Build Configuration](#build-configuration)
5. [Common Build Errors and Fixes](#common-build-errors-and-fixes)
6. [API Differences Between Versions](#api-differences-between-versions)
7. [Resource Files (GRC)](#resource-files-grc)
8. [JavaScript Bridge API](#javascript-bridge-api)
9. [Useful Resources](#useful-resources)

### Development Environment Setup

#### Required Software

| Component | ArchiCAD 27 | Notes |
|-----------|-------------|-------|
| Visual Studio | 2019 (v142 toolset) | Can use VS2022 with v142 toolset installed |
| Windows SDK | 10.0+ | |
| Python | 3.x | For resource compilation scripts |

#### Environment Variable

Set the `ARCHICAD_API_DEVKIT` environment variable to point to your DevKit:

```powershell
$env:ARCHICAD_API_DEVKIT = "C:\path\to\API.Development.Kit.WIN.27.6003"
```

#### DevKit Directory Structure

```
API.Development.Kit.WIN.27.6003/
├── Doc/
│   └── html/              # API Documentation (open index.html)
├── Examples/              # Example add-ons with CMakeLists.txt
├── Support/
│   ├── Inc/               # Header files
│   ├── Lib/               # Static libraries (ACAP_STAT.lib, ACAP_STATD.lib)
│   ├── Modules/           # Module libraries and headers
│   │   ├── DGLib/Win/     # DGImp.LIB
│   │   ├── GSRoot/Win/    # GSRootImp.LIB
│   │   ├── InputOutput/Win/
│   │   ├── JavascriptEngine/Win/
│   │   └── RS/Win/        # RSImp.LIB (resource strings)
│   └── Tools/
│       ├── CompileResources.py  # Official resource compiler
│       └── Win/ResConv.exe      # GRC to RC2 converter
└── VersionAndBuildNumber.txt
```

### DevKit Versions and Compatibility

#### Version Matching

The DevKit major version must match your ArchiCAD major version.

**Good news**: Minor build differences within the same major version are typically compatible!
- DevKit 27.6003 works with ArchiCAD 27.3.0 (build 6080) ✅

| ArchiCAD Version | DevKit Version | Visual Studio Toolset |
|------------------|----------------|----------------------|
| ArchiCAD 27.x | 27.6003+ | v142 (VS2019) |
| ArchiCAD 26.x | 26.x | v142 (VS2019) |
| ArchiCAD 29.x | 29.x | v143 (VS2022) |

Reference: [API Compatibility](https://graphisoft.github.io/archicad-api-devkit/apicompatibility_1.html)

#### Checking Versions

DevKit version is in `VersionAndBuildNumber.txt`:
```
!define API_MAINVERSION "27" 
!define AC_BUILD_NUMBER "6003"
```

Server version constants in `ACAPinc.h`:
```cpp
#define ServerMainVers_2700  0x001B  // ARCHICAD 27
#define ServerMainVers_2600  0x001A  // ARCHICAD 26
```

### MDID (Module Identifier)

#### What is MDID?

Every ArchiCAD add-on requires a unique Module Identifier (MDID) consisting of:
- **Developer ID**: Registered with Graphisoft, or use `MDID_APICD` (1193553710) for development
- **Local ID**: Unique ID for your add-on

#### Getting an MDID

For production add-ons, register at: https://archicadapi.Graphisoft.com/how-to-get-mdid-for-my-add-on

#### GRC Resource Definition

```grc
#include "MDIDs_APICD.h"

'MDID' 32500 "Add-On Identifier" {
    MDID_APICD      /* Developer ID: 1193553710 for API development */
    927492947       /* Your unique Local ID */
}
```

#### Standard MDIDs (from MDIDs_Public.h)

```cpp
#define MDID_GS1      1198731108
#define MDID_GS2      1198731090
#define MDID_APICD    1193553710  // For API development/testing
#define MDID_GSDEV    1193553710
```

**Important Notes:**

- **`MDID_APICD` (1193553710)** is a placeholder Developer ID for development/testing only
- **For production/public distribution**, you must:
  1. Register as an ArchiCAD developer at: https://archicadapi.graphisoft.com/profile/add-ons
  2. Get your own Developer ID from Graphisoft
  3. Generate a unique Local ID for your add-on
  4. Replace `MDID_APICD` with your Developer ID

**Why this matters:**
- If two add-ons share the same MDID, ArchiCAD will refuse to load them
- Using `MDID_APICD` is fine for development but NOT for production
- Each add-on must have a unique MDID to avoid conflicts

**Best Practice:** Register with Graphisoft and use your own Developer ID before distributing the add-on publicly.

### Build Configuration

#### Critical Preprocessor Definitions

For **Release** builds:
```xml
<PreprocessorDefinitions>
    WIN32;
    _WINDOWS;
    NDEBUG;
    _USRDLL;
    UNICODE;
    _UNICODE;
    _ITERATOR_DEBUG_LEVEL=0;   <!-- CRITICAL! -->
    ACExtension;
    %(PreprocessorDefinitions)
</PreprocessorDefinitions>
```

For **Debug** builds:
```xml
<PreprocessorDefinitions>
    WIN32;
    _WINDOWS;
    _DEBUG;
    _USRDLL;
    UNICODE;
    _UNICODE;
    ACExtension;
    %(PreprocessorDefinitions)
</PreprocessorDefinitions>
```

#### Runtime Library Settings

| Configuration | Runtime Library | Static Lib |
|---------------|-----------------|------------|
| Release | MultiThreadedDLL (`/MD`) | ACAP_STAT.lib |
| Debug | MultiThreadedDebugDLL (`/MDd`) | ACAP_STATD.lib |

#### Required Libraries (ArchiCAD 27)

Libraries are in `Support/Modules/*/Win/` with `*Imp.LIB` naming:

```xml
<AdditionalLibraryDirectories>
    $(ArchiCADDevKitPath)\Support\Lib;
    $(ArchiCADDevKitPath)\Support\Modules\DGLib\Win;
    $(ArchiCADDevKitPath)\Support\Modules\GSRoot\Win;
    $(ArchiCADDevKitPath)\Support\Modules\GSUtils\Win;
    $(ArchiCADDevKitPath)\Support\Modules\InputOutput\Win;
    $(ArchiCADDevKitPath)\Support\Modules\JavascriptEngine\Win;
    $(ArchiCADDevKitPath)\Support\Modules\RS\Win;
</AdditionalLibraryDirectories>

<AdditionalDependencies>
    ACAP_STAT.lib;
    DGImp.LIB;
    GSRootImp.LIB;
    GSUtilsImp.LIB;
    InputOutputImp.LIB;
    JavascriptEngineImp.LIB;
    RSImp.LIB;
    ws2_32.lib;
</AdditionalDependencies>
```

#### Output Settings

```xml
<TargetExt>.apx</TargetExt>
```

### Common Build Errors and Fixes

#### 1. "The file is an outdated Add-On that cannot be used with this Archicad version"

**Causes & Solutions:**

| Cause | Solution |
|-------|----------|
| Built in Debug mode | Build in **Release** mode |
| Missing `_ITERATOR_DEBUG_LEVEL=0` | Add to Release preprocessor definitions |
| Wrong DevKit version | Match DevKit to ArchiCAD version |
| Wrong Visual Studio toolset | Use v142 for AC27, v143 for AC29 |
| Missing VC++ Runtime | Install Visual C++ Redistributable |

Reference: [Graphisoft Community - Outdated AddOn](https://community.graphisoft.com/t5/Archicad-C-API/Outdated-AddOn/td-p/355699)

#### 2. LNK1181: cannot open input file 'ACAP_STAT.lib'

**Solution:** Libraries in AC27 are in `Support/Lib/` directly, not `Support/Lib/Win/`

#### 3. LNK1181: cannot open input file 'DGLib.lib'

**Solution:** AC27 uses different library names:
- `DGLib.lib` → `DGImp.LIB`
- `GSRoot.lib` → `GSRootImp.LIB`
- Located in `Support/Modules/*/Win/`

#### 4. Unresolved external: RSGetIndString_ParamAdapter

**Solution:** Add `RSImp.LIB` to linker dependencies

#### 5. error C2039: 'typeID': is not a member of 'API_Elem_Head'

**Solution:** AC26+ uses `type` (API_ElemType) instead of `typeID`:
```cpp
// Old (AC25 and earlier)
elemHead.typeID

// New (AC26+)
elemHead.type
```

#### 6. ResConv.exe: "Illegal target encoding!"

**Solution:** Use correct encoding parameters:
```
ResConv.exe -m r -T W -q utf8 utf8 -w 2 -p <path> -i <input> -o <output>
```

#### 7. RC1015: cannot open include file 'DGDefs.h'

**Solution:** Add DevKit paths to resource compiler:
```xml
<ResourceCompile>
    <AdditionalIncludeDirectories>
        $(ArchiCADDevKitPath)\Support\Inc;
        $(ArchiCADDevKitPath)\Support\Modules\DGLib;
    </AdditionalIncludeDirectories>
</ResourceCompile>
```

### API Differences Between Versions

#### ArchiCAD 27 API Changes

##### Menu Registration
```cpp
// Old
ACAPI_Register_Menu(...)
ACAPI_Install_MenuHandler(...)

// New (AC27)
ACAPI_MenuItem_RegisterMenu(...)
ACAPI_MenuItem_InstallMenuHandler(...)
```

##### Element Selection
```cpp
// Old
ACAPI_Element_Select(elemsToSelect, true);

// New (AC27)
ACAPI_Selection_Select(elemsToSelect, true);
```

##### Element Info
```cpp
// Old
ACAPI_Goodies(APIAny_GetElemTypeNameID, (void*)typeID, &name);
ACAPI_Database(APIDb_GetElementInfoStringID, &guid, &elemID);

// New (AC27)
ACAPI_Element_GetElemTypeName(elemType, name);
ACAPI_Element_GetElementInfoString(&guid, &elemID);
```

##### Environment/Settings
```cpp
// Old
ACAPI_Environment(APIEnv_GetSpecFolderID, &specFolderID, &tempFolder);

// New (AC27)
ACAPI_ProjectSettings_GetSpecFolder(&specFolderID, &tempFolder);
```

##### Notifications
```cpp
// Old
ACAPI_Notify_CatchSelectionChange(handler);

// New (AC27)
ACAPI_Notification_CatchSelectionChange(handler);
```

##### Palette Messages
```cpp
// Old (doesn't exist in AC27)
APIPalMsg_HideSticky, APIPalMsg_ShowSticky, etc.

// New (AC27)
APIPalMsg_HidePalette_Begin
APIPalMsg_HidePalette_End
APIPalMsg_DisableItems_Begin
APIPalMsg_DisableItems_End
APIPalMsg_OpenPalette
APIPalMsg_IsPaletteVisible
APIPalMsg_ClosePalette
```

##### Palette Flags
```cpp
// Old
API_PalEnabled_Model3D  // doesn't exist

// New (AC27)
API_PalEnabled_3D
API_PalEnabled_FloorPlan
API_PalEnabled_Section
API_PalEnabled_Detail
API_PalEnabled_Layout
API_PalEnabled_Worksheet
```

#### JavaScript Bridge (AC27)

The JavaScript API namespace changed from `DG::JS*` to `JS::*`:

```cpp
// Old
DG::JSObject, DG::JSFunction, DG::JSBase, DG::JSValue

// New (AC27)
JS::Object, JS::Function, JS::Base, JS::Value, JS::Array
```

Usage:
```cpp
#include "JSValues.hpp"

GS::Ref<JS::Object> jsObj = new JS::Object("name");
jsObj->AddItem("key", GS::Ref<JS::Base>(new JS::Value("string")));
jsObj->AddItem("number", GS::Ref<JS::Base>(new JS::Value((Int32)42)));
jsObj->AddItem(GS::Ref<JS::Function>(new JS::Function("funcName", callback)));
browser.RegisterAsynchJSObject(jsObj);
```

#### GUID Conversion

```cpp
// GS::Guid to API_Guid
API_Guid apiGuid = GSGuid2APIGuid(gsGuid);

// API_Guid to GS::Guid
GS::Guid gsGuid = APIGuid2GSGuid(apiGuid);
```

### Resource Files (GRC)

#### File Structure

```
RFIX/                    # Non-localizable resources
    IfcTesterArchiCADFix.grc  # MDID, icons
RINT/ (or RENG/)         # Localizable resources (English)
    IfcTesterArchiCAD.grc     # Strings, menus, dialogs
RFIX.win/                # Windows-specific
    IfcTesterArchiCAD.rc2     # Windows resources
```

#### RFIX GRC Example (Non-localizable)

```grc
#include "MDIDs_APICD.h"

'MDID' 32500 "Add-On Identifier" {
    MDID_APICD
    927492947
}
```

#### RINT GRC Example (Localizable)

```grc
#include "ResourceIDs.hpp"

'STR#' 32000 "Add-on Name and Description" {
    /* [1] */ "IfcTester"
    /* [2] */ "IFC Testing Add-On for ArchiCAD"
}

'STR#' 32500 "Menu strings" {
    /* [ ] */ "Audit"
    /* [ ] */ "IFC Testing"
    /* [1] */     "IfcTester Panel^ES^EE^EI^ED^EW^ET^EM"
}
```

#### Menu String Modifiers

| Code | Meaning |
|------|---------|
| `^E3` | Enable in 3D window |
| `^ES` | Enable in Section |
| `^EE` | Enable in Elevation |
| `^EI` | Enable in Interior Elevation |
| `^ED` | Enable in Detail |
| `^EW` | Enable in Worksheet |
| `^ET` | Enable in Layout |
| `^EM` | Enable in Master Layout |

### CheckEnvironment Function

```cpp
API_AddonType __ACDLL_CALL CheckEnvironment(API_EnvirParams* envir)
{
    RSGetIndString(&envir->addOnInfo.name, AddOnInfoResId, 1, ACAPI_GetOwnResModule());
    RSGetIndString(&envir->addOnInfo.description, AddOnInfoResId, 2, ACAPI_GetOwnResModule());

    return APIAddon_Normal;  // Use Normal, not Preload
}
```

Return values:
- `APIAddon_Normal` - Standard add-on (recommended)
- `APIAddon_Preload` - Preloaded add-on (loaded before UI)

### CEF Browser Control - Loading Web Apps

#### Loading HTML

The browser control can load HTML in two ways:

1. **Embedded HTML** (official example approach):
```cpp
// Load HTML from embedded resource
GSHandle data = RSLoadResource('DATA', ACAPI_GetOwnResModule(), 100);
GS::UniString htmlStr(*data, BMhGetSize(data));
browser.LoadHTML(htmlStr);
```

2. **From file:// URL** (for complex web apps):
```cpp
#include "Location.hpp"

// Get add-on location and construct file:// URL
IO::Location ownLoc;
ACAPI_GetOwnLocation(&ownLoc);
ownLoc.DeleteLastLocalName();  // Remove filename, get folder
ownLoc.AppendToLocal(IO::Name("WebApp"));
ownLoc.AppendToLocal(IO::Name("index.html"));

GS::UniString urlStr;
ownLoc.ToURL(&urlStr);
browser.LoadURL(urlStr);
```

#### WebApp Folder Structure

For complex web apps with JavaScript, CSS, images, etc.:

```
YourAddon/
├── YourAddon.apx
└── WebApp/
    ├── index.html
    ├── assets/
    │   ├── *.js
    │   └── *.css
    └── ...
```

#### Panel Resize Handling

**Important**: Use `BeginMoveResizeItems()` / `EndMoveResizeItems()` pattern:

```cpp
void BrowserPalette::PanelResized(const DG::PanelResizeEvent& ev)
{
    BeginMoveResizeItems();
    browser.Resize(ev.GetHorizontalChange(), ev.GetVerticalChange());
    EndMoveResizeItems();
}
```

Without this pattern, resizing can cause crashes!

#### Key Header Files

| File | Purpose |
|------|---------|
| `ACAPinc.h` | Main API header |
| `APIdefs_Elements.h` | Element definitions |
| `APIdefs_Callback.h` | Callback function types |
| `APIdefs_Registration.h` | Registration types |
| `ACAPI_MigrationHeader.hpp` | Legacy API compatibility |
| `MDIDs_APICD.h` | Development MDIDs |
| `MDIDs_Public.h` | Public MDID definitions |
| `JSValues.hpp` | JavaScript bridge types |

#### Example Projects in DevKit

- `Browser_Control` - Browser palette example
- `DG_Test` - Dialog/UI example
- `Element_Test` - Element manipulation
- `Selection_Manager` - Selection handling
- `Panel_Test` - Panel/palette example

### Build with CMake (Recommended)

The **recommended** approach is to use CMake like the official examples. This ensures proper resource compilation using `CompileResources.py`:

```powershell
# Configure
cd archicad
mkdir cmake-build
cd cmake-build
cmake .. -G "Visual Studio 17 2022" -A x64 -T v142 -DAC_API_DEVKIT_DIR="C:\code\archicad-api\API.Development.Kit.WIN.27.6003"

# Build
cmake --build . --config Release
```

The output will be in `cmake-build/Release/IfcTesterArchiCAD.apx`.

#### Why CMake?

The CMake build uses:
1. **Official CompileResources.py** script for proper resource compilation
2. **Automatic library linking** - all module libraries are linked automatically
3. **Correct export definitions** via `target_link_options`
4. **Proper preprocessor definitions** including `_ITERATOR_DEBUG_LEVEL=0`

#### Manual Build (Alternative)

```powershell
$DevKitPath = "C:\code\archicad-api\API.Development.Kit.WIN.27.6003"
$env:ARCHICAD_API_DEVKIT = $DevKitPath

& "C:\Program Files\Microsoft Visual Studio\2022\Community\MSBuild\Current\Bin\MSBuild.exe" `
    "IfcTesterArchiCAD.vcxproj" `
    /p:Configuration=Release `
    /p:Platform=x64
```

### Resource Compilation

GRC files are compiled using GRAPHISOFT's ResConv tool (included in the DevKit). The Visual Studio project runs this automatically in the pre-build step.

### Version Compatibility

The add-on is designed to work with ArchiCAD 25-27. Different versions may require:
- Rebuilding against the appropriate DevKit
- Minor API adjustments for deprecated/changed functions

### Useful Resources

#### Official Documentation

| Resource | URL/Location |
|----------|--------------|
| DevKit HTML Docs | `{DevKit}/Doc/html/index.html` |
| API Developer Site | https://archicadapi.Graphisoft.com |
| MDID Registration | https://archicadapi.Graphisoft.com/how-to-get-mdid-for-my-add-on |
| FAQ | https://archicadapi.Graphisoft.com/faq |

#### Community Resources

| Resource | URL |
|----------|-----|
| Graphisoft Community - C++ API | https://community.graphisoft.com/t5/Archicad-C-API/bd-p/archicad_cpp_api |
| Outdated AddOn Discussion | https://community.graphisoft.com/t5/Archicad-C-API/Outdated-AddOn/td-p/355699 |

#### Blog Articles (Official Tutorials)

| Article | URL |
|---------|-----|
| Getting Started with Add-Ons | https://archicadapi.graphisoft.com/getting-started-with-archicad-add-ons |
| Browser Control & JavaScript | https://archicadapi.graphisoft.com/browser-control-and-javascript-connection |
| CMake Template | https://archicadapi.graphisoft.com/cmake-template-for-add-ons |
| How to get MDID | https://archicadapi.graphisoft.com/how-to-get-mdid-for-my-add-on |
| Life of an Add-On | https://archicadapi.graphisoft.com/life-of-an-archicad-add-on |
| Multi-language Add-Ons | https://archicadapi.graphisoft.com/how-to-create-multi-language-add-on |

#### JavaScript/CEF Debugging

To debug JavaScript in the embedded browser:

1. Set registry key `CefUseFixedDebugPort` to `true` at:
   `HKEY_CURRENT_USER\SOFTWARE\GRAPHISOFT\Debug\DG`

2. Restart ArchiCAD

3. Open Chrome and navigate to: `http://localhost:9222`

### Development Troubleshooting Checklist

- [ ] DevKit version matches ArchiCAD version
- [ ] Building in **Release** mode (not Debug)
- [ ] `_ITERATOR_DEBUG_LEVEL=0` in Release preprocessor definitions
- [ ] Correct Visual Studio toolset (v142 for AC27)
- [ ] All required libraries linked
- [ ] MDID properly defined in GRC
- [ ] Using correct API function names for target version
- [ ] `APIAddon_Normal` returned from CheckEnvironment

*Last updated: November 2024*
*Tested with: ArchiCAD 27, DevKit 27.6003, Visual Studio 2022 with v142 toolset*

## License

See the LICENSE file in the project root.

## Contributing

1. Fork the repository
2. Create a feature branch
3. Make your changes
4. Test with ArchiCAD
5. Submit a pull request

## Related Projects

- [IfcTester Revit Plugin](../revit/README.md) - Revit version of this plugin
- [IfcTester Web App](../web/README.md) - The web application hosted by this add-on
